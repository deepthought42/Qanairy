<form id="signup">
  <fieldset>
    <legend>Sign up</legend>
    <p>
      <input type="email" id="signup-email" placeholder="Email" required/>
    </p>
    <p>
      <input type="password" id="signup-password" placeholder="Password" required/>
    </p>
    <p>
      Free
      <input type="hidden" id="subscription" required/>
    </p>
  </fieldset>

</form>

<form id="payment-form">
  <div class="form-row">
    <label for="card-element">
      Credit or debit card
    </label>
    <div id="card-element">
      <!-- A Stripe Element will be inserted here. -->
    </div>

    <!-- Used to display Element errors. -->
    <div id="card-errors" role="alert"></div>
  </div>
</form>

<button id="signup" >Sign up</button>


<script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
<script src="https://js.stripe.com/v3/"></script>

<script>
  var settings = {
    "async": true,
    "crossDomain": true,
    "url": "https://staging-qanairy.auth0.com/dbconnections/signup",
    "method": "POST",
    "headers": {
      "content-type": "application/x-www-form-urlencoded"
    },
    "data": {
      "client_id": "mMomHg1ZhzZkM4Tsz2NGkdJH3eeJqIq6",
      "email": $('#email').val(),
      "password": $('#password').val(),
      "connection": "Username-Password-Authentication",
      "user_metadata" :{
        "subscription_plan": $('#subscription').val()
      }
    }
  }


  var stripe = Stripe('pk_test_key');

  var elements = stripe.elements();

  var style = {
    base: {
      color: '#32325d',
      lineHeight: '18px',
      fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
      fontSmoothing: 'antialiased',
      fontSize: '16px',
      '::placeholder': {
        color: '#aab7c4'
      }
    },
    invalid: {
      color: 'fa755a',
      iconColor: '#fa755a'
    }
  };

  var card = elements.create('card', {Style: style});
  card.mount('#card-element');

  //handle form submission
  function stripeTokenHandler(token){

    //submit token with ajax
    $.ajax({
      url: "/subscribe",
      type: 'POST',
      data: {plan : plan, source_token: token},
      success: function(){
        console.log("Successfully processed subscription");
        window.location.href = "https://app.qanairy.com";
      },
      onFailure: function() {
        console.log("Error occurred while processing subscription request");
      }
    });
  }

  $("#signup").on('click', function(){
    $.ajax(settings).done(function (response) {
      console.log(response);
      //process payment through stripe
      stripe.createToken(card).then(function(result){
        if(result.error){
          //inform the user there was an error
          var errorElement = document.getElementById('card-errors');
          errorElement.textContent = result.error.message;
        }
        else {
          //update user subscription
          //send token to the server
          stripeTokenHandler(result.token);
        }
      });
    });
  });
</script>
